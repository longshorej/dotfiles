#!/bin/bash

set -e

which sudo > /dev/null 2>&1 || (echo "* install sudo" && exit 1)

echo "* running install-dotfiles"

INITIAL_SUM=`md5sum $BASH_SOURCE`

cd ${0%/*}

PACKAGES=(
  abcde
  ack-grep
  build-essential
  cifs-utils
  chromium
  curl
  dconf-cli
  ffmpeg
  flac
  emacs
  feh
  gedit
  glyrc
  gnome-terminal
  gnome-themes-standard
  i3
  icedove
  iceweasel
  irssi
  libreoffice
  network-manager-gnome
  network-manager-vpnc
  network-manager-vpnc-gnome
  nodejs
  openjdk-8-jdk
  openjdk-8-source
  openssh-client
  parcellite
  pavucontrol
  pidgin
  python3-pip
  rdesktop
  rofi
  rsyslog
  silversearcher-ag
#  thunderbird
  unzip
  vpnc
  xautolock
  xorg
  youtube-dl
)

pwd=`pwd`
mkdir -p ~/bin
echo "#!/usr/bin/env bash" > ~/bin/install-dotfiles
echo "exec $pwd/install-dotfiles" >> ~/bin/install-dotfiles
chmod +x ~/bin/install-dotfiles

cd ..

git pull
git submodule foreach --recursive git reset --hard
git submodule foreach git fetch origin master
git submodule foreach git reset --hard FETCH_HEAD
git submodule foreach git clean -df

rsync -rcip --exclude=.git --exclude=README.md --exclude=LICENSE --exclude bin/install-dotfiles . ~

NOW_SUM=`cd bin && md5sum $BASH_SOURCE`

for PACKAGE in "${PACKAGES[@]}"; do
  dpkg -s "$PACKAGE" >/dev/null 2>&1 || sudo apt-get -y install "$PACKAGE"
done

for MODULE in ${LONGSHOREJ_DOTFILES_MODULES[@]}; do
  if [ -d "$MODULE" ]; then
     echo "* installing module $MODULE"

     (cd "$MODULE" && git pull)
     (cd "$MODULE" && git submodule foreach -q --recursive 'git checkout $(git config -f $toplevel/.gitmodules submodule.$name.branch || echo master) && git pull')
     (cd "$MODULE" && rsync -rcip --exclude=.git --exclude=README.md --exclude=LICENSE . ~)
  fi
done


xdg-mime default eog.desktop image/png
xdg-mime default eog.desktop image/jpg
xdg-mime default eog.desktop image/gif
xdg-mime default evince.desktop application/pdf

systemctl --user enable emacs
systemctl --user start emacs
