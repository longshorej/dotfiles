#!/bin/bash

set -e

which sudo > /dev/null 2>&1 || (echo ">> install sudo" && exit 1)

cd ${0%/*}

INITIAL_SUM=`md5sum $BASH_SOURCE`

pwd=`pwd`
echo "#!/usr/bin/env bash" > ~/bin/install-dotfiles
echo "exec $pwd/install-dotfiles" >> ~/bin/install-dotfiles
chmod +x ~/bin/install-dotfiles

cd ..

git pull
#git submodule foreach git pull origin master

git submodule foreach -q --recursive 'git checkout $(git config -f $toplevel/.gitmodules submodule.$name.branch || echo master) && git pull'
rsync -rcip --exclude=.git --exclude=README.md --exclude=LICENSE --exclude bin/install-dotfiles . ~

NOW_SUM=`cd bin && md5sum $BASH_SOURCE`

if [[ $INITIAL_SUM != $NOW_SUM ]]; then
  echo ">> install-dotfiles changed, restarting"
  exec ./bin/install-dotfiles
fi

systemctl --user enable emacs
systemctl --user start emacs

sudo apt-get install -y \
  ack-grep \
  build-essential \
  curl \
  ffmpeg \
  emacs \
  feh \
  i3 \
  network-manager-gnome \
  network-manager-vpnc \
  network-manager-vpnc-gnome \
  nodejs \
  openjdk-8-jdk \
  openjdk-8-source \
  openssh-client \
  parcellite \
  python3-pip \
  rofi \
  rsyslog \
  silversearcher-ag \
  unrar \
  unzip \
  vpnc \
  xautolock \
  youtube-dl
